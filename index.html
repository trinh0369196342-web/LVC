<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ªãch V·ª• In ·∫§n - Kh√°ch H√†ng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .hidden { display: none !important; }
        .active-tab { border-bottom: 2px solid #3b82f6; color: #3b82f6; font-weight: bold; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div id="auth-container" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-8 rounded shadow-md w-96">
            <h2 class="text-2xl font-bold mb-6 text-center text-blue-600">ƒêƒÉng Nh·∫≠p</h2>
            <input type="email" id="email" placeholder="Email (VD: fuwun123@gamil.com)" class="w-full p-2 mb-4 border rounded">
            <input type="password" id="password" placeholder="M·∫≠t kh·∫©u" class="w-full p-2 mb-4 border rounded">
            <input type="text" id="full_name" placeholder="H·ªç t√™n ƒë·∫ßy ƒë·ªß (N·∫øu ƒëƒÉng k√Ω)" class="w-full p-2 mb-4 border rounded hidden">
            
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700 mb-2">ƒêƒÉng Nh·∫≠p</button>
            <button onclick="toggleAuthMode()" id="auth-switch-btn" class="w-full text-blue-500 text-sm">Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay</button>
            <p id="auth-error" class="text-red-500 text-sm mt-2 text-center"></p>
        </div>
    </div>

    <div id="app-container" class="hidden min-h-screen pb-20">
        <header class="bg-white shadow p-4 flex justify-between items-center sticky top-0 z-10">
            <h1 class="text-xl font-bold text-blue-600">D·ªãch V·ª• In ·∫§n</h1>
            <div class="flex items-center gap-3">
                <span id="user-display-name" class="font-medium">User</span>
                <button onclick="handleLogout()" class="text-red-500 text-sm border border-red-500 px-2 py-1 rounded">Tho√°t</button>
            </div>
        </header>

        <div class="flex justify-center bg-white border-t">
            <button onclick="switchTab('create-order')" id="tab-create" class="flex-1 py-3 text-center active-tab">T·∫°o ƒê∆°n H√†ng</button>
            <button onclick="switchTab('my-orders')" id="tab-list" class="flex-1 py-3 text-center text-gray-500">ƒê∆°n C·ªßa T√¥i</button>
            <button onclick="switchTab('profile')" id="tab-profile" class="flex-1 py-3 text-center text-gray-500">T√†i Kho·∫£n</button>
        </div>

        <div id="view-create-order" class="p-4 max-w-lg mx-auto">
            <div class="flex gap-4 mb-6">
                <label class="flex items-center cursor-pointer">
                    <input type="radio" name="orderType" value="file" checked onchange="toggleOrderType()" class="mr-2"> In File (T√†i li·ªáu)
                </label>
                <label class="flex items-center cursor-pointer">
                    <input type="radio" name="orderType" value="text" onchange="toggleOrderType()" class="mr-2"> In Ch·ªØ (Bi·ªÉn b·∫£ng)
                </label>
            </div>

            <div id="form-file" class="bg-white p-4 rounded shadow">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">T·∫£i file l√™n (PDF, DOCX, ·∫¢nh)</label>
                    <input type="file" id="file-upload" class="w-full border p-2 rounded">
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium">S·ªë trang</label>
                        <input type="number" id="page-count" value="1" min="1" oninput="calculatePrice()" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">C·ª° ch·ªØ</label>
                        <select id="font-size" class="w-full border p-2 rounded">
                            <option value="12">12 (Chu·∫©n)</option>
                            <option value="14">14</option>
                            <option value="16">16</option>
                        </select>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">ƒê·ªô ƒë·∫≠m</label>
                    <input type="range" id="density" min="1" max="3" value="1" class="w-full" oninput="calculatePrice()">
                    <div class="flex justify-between text-xs text-gray-500">
                        <span>Th∆∞·ªùng</span><span>ƒê·∫≠m</span><span>Si√™u ƒë·∫≠m</span>
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">H∆∞·ªõng gi·∫•y</label>
                    <select id="orientation" class="w-full border p-2 rounded">
                        <option value="portrait">D·ªçc</option>
                        <option value="landscape">Ngang</option>
                    </select>
                </div>
            </div>

            <div id="form-text" class="bg-white p-4 rounded shadow hidden">
                <div class="mb-4">
                    <label class="block text-sm font-medium">V·ªã tr√≠ d√°n</label>
                    <div class="flex gap-2">
                        <input type="text" id="room-num" placeholder="Ph√≤ng (VD: 201)" class="w-1/2 border p-2 rounded">
                        <input type="text" id="floor-num" placeholder="T·∫ßng" class="w-1/2 border p-2 rounded">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium">S·ªë l∆∞·ª£ng b·∫£ng (Max 8)</label>
                    <select id="board-count" onchange="renderBoardSlots()" class="w-full border p-2 rounded">
                        <option value="0">Ch·ªçn s·ªë l∆∞·ª£ng...</option>
                        <option value="1">1 B·∫£ng</option>
                        <option value="2">2 B·∫£ng</option>
                        <option value="3">3 B·∫£ng</option>
                        <option value="4">4 B·∫£ng</option>
                        <option value="5">5 B·∫£ng</option>
                        <option value="6">6 B·∫£ng</option>
                        <option value="7">7 B·∫£ng</option>
                        <option value="8">8 B·∫£ng</option>
                    </select>
                </div>
                <div id="board-slots" class="grid grid-cols-2 gap-3 mb-4"></div>
            </div>

            <div class="mt-6 border-t pt-4">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-600">T·∫°m t√≠nh:</span>
                    <span id="total-price" class="text-2xl font-bold text-red-600">0 ‚Ç´</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="resetForm()" class="w-1/3 bg-gray-200 text-gray-700 py-3 rounded">L√†m l·∫°i</button>
                    <button onclick="submitOrder()" class="w-2/3 bg-blue-600 text-white py-3 rounded font-bold hover:bg-blue-700">T·∫†O ƒê∆†N H√ÄNG</button>
                </div>
            </div>
        </div>

        <div id="view-my-orders" class="hidden p-4 max-w-lg mx-auto">
            <h2 class="font-bold text-lg mb-4">L·ªãch s·ª≠ ƒë∆°n h√†ng</h2>
            <div id="orders-list" class="space-y-4">
                <p class="text-center text-gray-500">ƒêang t·∫£i...</p>
            </div>
        </div>

        <div id="view-profile" class="hidden p-4 max-w-lg mx-auto">
             <div class="bg-white p-4 rounded shadow text-center">
                 <img id="profile-avatar" src="" class="w-24 h-24 rounded-full mx-auto mb-4 border">
                 <h3 id="profile-name" class="font-bold text-xl">User Name</h3>
                 <p id="profile-email" class="text-gray-500 mb-4">email@example.com</p>
                 <hr class="my-4">
                 <p class="text-sm text-gray-400">T√≠nh nƒÉng c·∫≠p nh·∫≠t Profile ƒë·∫ßy ƒë·ªß nh∆∞ y√™u c·∫ßu (ƒêang ph√°t tri·ªÉn UI)...</p>
             </div>
        </div>
    </div>

    <div id="board-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded w-11/12 max-w-md">
            <h3 class="font-bold text-lg mb-4">Nh·∫≠p n·ªôi dung B·∫£ng <span id="modal-board-idx"></span></h3>
            <label class="block text-sm mb-1">Ti√™u ƒë·ªÅ M√¥n</label>
            <input type="text" id="modal-subject" class="w-full border p-2 rounded mb-3" placeholder="VD: Ng·ªØ VƒÉn">
            
            <label class="block text-sm mb-1">N·ªôi dung chi ti·∫øt</label>
            <textarea id="modal-content" rows="4" class="w-full border p-2 rounded mb-1" placeholder="Nh·∫≠p n·ªôi dung..."></textarea>
            <p class="text-xs text-red-500 mb-4">* L∆∞u √Ω: Ch·ªâ in t·ª± lu·∫≠n, C·∫§M in tr·∫Øc nghi·ªám.</p>
            
            <div class="flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-200 rounded">H·ªßy</button>
                <button onclick="saveBoardData()" class="px-4 py-2 bg-blue-600 text-white rounded">L∆∞u</button>
            </div>
        </div>
    </div>

    <div id="chat-widget" class="fixed bottom-4 right-4 z-40">
        <button onclick="toggleChat()" id="chat-btn" class="bg-blue-600 text-white p-4 rounded-full shadow-lg hover:bg-blue-700">
            üí¨ H·ªó tr·ª£
        </button>
        
        <div id="chat-window" class="hidden absolute bottom-16 right-0 w-80 bg-white rounded-lg shadow-xl border overflow-hidden flex flex-col h-96">
            <div class="bg-blue-600 text-white p-3 flex justify-between items-center">
                <span class="font-bold">Chat v·ªõi Admin</span>
                <button onclick="toggleChat()" class="text-sm">‚úï</button>
            </div>
            <div id="chat-messages" class="flex-1 p-3 overflow-y-auto bg-gray-50 text-sm space-y-2">
                </div>
            <div class="p-2 border-t flex">
                <input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." class="flex-1 border p-2 rounded-l text-sm">
                <button onclick="sendMessage()" class="bg-blue-600 text-white px-3 rounded-r">‚û§</button>
            </div>
        </div>
    </div>

    <script src="script_index.js"></script>
    <script>
        // --- BI·∫æN TO√ÄN C·ª§C ---
        let currentUser = null;
        let boardsData = []; // L∆∞u d·ªØ li·ªáu 8 b·∫£ng: [{id:1, mon:'', noidung:''}, ...]
        let currentModalIdx = 0;
        let isRegistering = false;

        // --- AUTHENTICATION ---
        async function checkUser() {
            const { data: { user } } = await _supabase.auth.getUser();
            if (user) {
                currentUser = user;
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                loadProfile();
                loadSettings(); // T·∫£i b·∫£ng gi√° t·ª´ admin
                subscribeRealtime(); // B·∫≠t l·∫Øng nghe chat/ƒë∆°n
            }
        }
        checkUser();

        async function handleLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const fullName = document.getElementById('full_name').value;
            const errorP = document.getElementById('auth-error');

            try {
                if (isRegistering) {
                    // ƒêƒÉng k√Ω
                    const { data, error } = await _supabase.auth.signUp({
                        email, password,
                        options: { data: { full_name: fullName } }
                    });
                    if (error) throw error;
                    alert('ƒêƒÉng k√Ω th√†nh c√¥ng! Vui l√≤ng ki·ªÉm tra email ho·∫∑c ƒëƒÉng nh·∫≠p.');
                    toggleAuthMode();
                } else {
                    // ƒêƒÉng nh·∫≠p
                    const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    location.reload();
                }
            } catch (err) {
                errorP.innerText = err.message;
            }
        }

        function toggleAuthMode() {
            isRegistering = !isRegistering;
            document.getElementById('full_name').classList.toggle('hidden');
            document.getElementById('auth-switch-btn').innerText = isRegistering ? "ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p" : "Ch∆∞a c√≥ t√†i kho·∫£n? ƒêƒÉng k√Ω ngay";
            document.querySelector('#auth-container h2').innerText = isRegistering ? "ƒêƒÉng K√Ω" : "ƒêƒÉng Nh·∫≠p";
        }

        async function handleLogout() {
            await _supabase.auth.signOut();
            location.reload();
        }

        async function loadProfile() {
            const { data } = await _supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            if(data) {
                document.getElementById('user-display-name').innerText = data.full_name || data.email;
                document.getElementById('profile-name').innerText = data.full_name;
                document.getElementById('profile-email').innerText = data.email;
                // N·∫øu l√† Admin, chuy·ªÉn h∆∞·ªõng sang trang admin
                if (data.role === 'admin') {
                   if(confirm('B·∫°n l√† Admin. Chuy·ªÉn sang trang qu·∫£n tr·ªã?')) {
                       window.location.href = 'admin.html';
                   }
                }
            }
        }

        async function loadSettings() {
            const { data } = await _supabase.from('settings').select('*').single();
            if (data) GLOBAL_SETTINGS = data;
        }

        // --- LOGIC GIAO DI·ªÜN (TABS) ---
        function switchTab(tabId) {
            // ·∫®n h·∫øt view
            document.getElementById('view-create-order').classList.add('hidden');
            document.getElementById('view-my-orders').classList.add('hidden');
            document.getElementById('view-profile').classList.add('hidden');
            
            // Reset style tab
            ['tab-create', 'tab-list', 'tab-profile'].forEach(id => {
                document.getElementById(id).className = 'flex-1 py-3 text-center text-gray-500';
            });

            // Hi·ªán view ch·ªçn
            if(tabId === 'create-order') {
                document.getElementById('view-create-order').classList.remove('hidden');
                document.getElementById('tab-create').className = 'flex-1 py-3 text-center active-tab';
            } else if (tabId === 'my-orders') {
                document.getElementById('view-my-orders').classList.remove('hidden');
                document.getElementById('tab-list').className = 'flex-1 py-3 text-center active-tab';
                loadMyOrders(); // T·∫£i l·∫°i danh s√°ch
            } else {
                document.getElementById('view-profile').classList.remove('hidden');
                document.getElementById('tab-profile').className = 'flex-1 py-3 text-center active-tab';
            }
        }

        function toggleOrderType() {
            const type = document.querySelector('input[name="orderType"]:checked').value;
            if (type === 'file') {
                document.getElementById('form-file').classList.remove('hidden');
                document.getElementById('form-text').classList.add('hidden');
            } else {
                document.getElementById('form-file').classList.add('hidden');
                document.getElementById('form-text').classList.remove('hidden');
            }
            calculatePrice();
        }

        // --- LOGIC T√çNH TI·ªÄN ---
        function calculatePrice() {
            let total = 0;
            const type = document.querySelector('input[name="orderType"]:checked').value;

            if (type === 'file') {
                const pages = parseInt(document.getElementById('page-count').value) || 0;
                const densityVal = parseInt(document.getElementById('density').value);
                // H·ªá s·ªë ƒë·∫≠m: 1->1, 2->1.1 (20% fee?), 3->1.3
                // Theo logic b·∫°n y√™u c·∫ßu: c√≥ ph·ª• ph√≠ ƒë·∫≠m
                let densityMult = 1;
                if(densityVal === 2) densityMult = 1 + (GLOBAL_SETTINGS.density_fee_percent / 100); 
                if(densityVal === 3) densityMult = 1 + ((GLOBAL_SETTINGS.density_fee_percent * 2) / 100);

                total = pages * GLOBAL_SETTINGS.price_per_page * densityMult;
            } else {
                const count = parseInt(document.getElementById('board-count').value) || 0;
                total = count * GLOBAL_SETTINGS.price_per_board;
            }

            document.getElementById('total-price').innerText = formatCurrency(total);
            return total;
        }

        // --- LOGIC IN CH·ªÆ (DYNAMIC BOARDS) ---
        function renderBoardSlots() {
            const count = parseInt(document.getElementById('board-count').value);
            const container = document.getElementById('board-slots');
            container.innerHTML = '';
            boardsData = []; // Reset data khi ƒë·ªïi s·ªë l∆∞·ª£ng

            for (let i = 1; i <= count; i++) {
                boardsData.push({ id: i, subject: '', content: '' }); // Init data empty
                
                const btn = document.createElement('div');
                btn.className = 'border-2 border-dashed border-gray-300 rounded p-4 text-center cursor-pointer hover:border-blue-500 hover:text-blue-600 bg-gray-50';
                btn.innerHTML = `<strong>B·∫£ng ${i}</strong><br><span class="text-xs text-gray-400" id="preview-${i}">(Ch∆∞a c√≥ n·ªôi dung)</span>`;
                btn.onclick = () => openBoardModal(i);
                container.appendChild(btn);
            }
            calculatePrice();
        }

        function openBoardModal(idx) {
            currentModalIdx = idx;
            const data = boardsData[idx - 1];
            
            document.getElementById('modal-board-idx').innerText = idx;
            document.getElementById('modal-subject').value = data.subject;
            document.getElementById('modal-content').value = data.content;
            
            document.getElementById('board-modal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('board-modal').classList.add('hidden');
        }

        function saveBoardData() {
            const subject = document.getElementById('modal-subject').value;
            const content = document.getElementById('modal-content').value;
            
            // Validate s∆° b·ªô
            if (content.match(/[ABCD]\./)) { // Check tr·∫Øc nghi·ªám ƒë∆°n gi·∫£n
                 if(!confirm('C·∫£nh b√°o: C√≥ v·∫ª b·∫°n ƒëang nh·∫≠p tr·∫Øc nghi·ªám (A. B. C...). Ti·∫øp t·ª•c?')) return;
            }

            boardsData[currentModalIdx - 1] = { id: currentModalIdx, subject, content };
            
            // C·∫≠p nh·∫≠t UI Preview
            document.getElementById(`preview-${currentModalIdx}`).innerText = subject ? subject : "(ƒê√£ nh·∫≠p)";
            document.getElementById(`preview-${currentModalIdx}`).classList.add('text-green-600');
            
            closeModal();
        }

        // --- SUBMIT ORDER ---
        async function submitOrder() {
            if(!currentUser) return alert("Vui l√≤ng ƒëƒÉng nh·∫≠p!");
            
            const type = document.querySelector('input[name="orderType"]:checked').value;
            const originalPrice = calculatePrice();
            
            let payload = {
                user_id: currentUser.id,
                type: type,
                original_price: Math.round(originalPrice),
                status: 'pending'
            };

            if (type === 'file') {
                const fileInput = document.getElementById('file-upload');
                if(fileInput.files.length === 0) return alert("Vui l√≤ng ch·ªçn file!");
                
                // Demo: Ch∆∞a upload th·∫≠t l√™n Storage (c·∫ßn setup Storage bucket), t·∫°m th·ªùi l·∫•y t√™n file
                payload.file_url = "demo_file_" + fileInput.files[0].name; 
                payload.page_count = document.getElementById('page-count').value;
                payload.font_size = document.getElementById('font-size').value;
                payload.density = document.getElementById('density').value == 1 ? 'normal' : 'bold';
                payload.is_landscape = document.getElementById('orientation').value === 'landscape';

            } else {
                const count = parseInt(document.getElementById('board-count').value);
                if (count === 0) return alert("Vui l√≤ng ch·ªçn s·ªë l∆∞·ª£ng b·∫£ng!");
                // Check xem ƒë√£ ƒëi·ªÅn h·∫øt ch∆∞a
                const emptyBoard = boardsData.find(b => !b.content);
                if (emptyBoard) return alert(`Vui l√≤ng ƒëi·ªÅn n·ªôi dung cho B·∫£ng ${emptyBoard.id}`);
                
                payload.board_count = count;
                payload.boards_data = boardsData;
                payload.room_number = document.getElementById('room-num').value;
                payload.floor_number = document.getElementById('floor-num').value;
            }

            const { error } = await _supabase.from('orders').insert(payload);
            if (error) {
                alert("L·ªói: " + error.message);
            } else {
                alert("T·∫°o ƒë∆°n h√†ng th√†nh c√¥ng!");
                resetForm();
                switchTab('my-orders');
            }
        }

        function resetForm() {
            document.getElementById('page-count').value = 1;
            document.getElementById('board-count').value = 0;
            document.getElementById('board-slots').innerHTML = '';
            document.getElementById('total-price').innerText = '0 ‚Ç´';
            // Clear inputs...
        }

        // --- QU·∫¢N L√ù ƒê∆†N H√ÄNG (MY ORDERS) ---
        async function loadMyOrders() {
            const { data: orders } = await _supabase
                .from('orders')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });
            
            const container = document.getElementById('orders-list');
            container.innerHTML = '';
            
            if(!orders || orders.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o.</p>';
                return;
            }

            orders.forEach(order => {
                const statusColor = {
                    'pending': 'text-yellow-600 bg-yellow-100',
                    'processing': 'text-blue-600 bg-blue-100',
                    'payment_pending': 'text-orange-600 bg-orange-100',
                    'completed': 'text-green-600 bg-green-100',
                    'cancelled': 'text-gray-600 bg-gray-200'
                };
                
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded shadow border-l-4 ' + (order.status === 'pending' ? 'border-yellow-500' : 'border-gray-300');
                
                let detailHtml = '';
                if(order.type === 'file') {
                    detailHtml = `<p class="text-sm">File: <b>${order.file_url}</b> (${order.page_count} trang)</p>`;
                } else {
                    detailHtml = `<p class="text-sm">In Ch·ªØ: <b>${order.board_count} b·∫£ng</b> (Ph√≤ng ${order.room_number || '?'})</p>`;
                }

                // N√∫t ch·ª©c nƒÉng
                let actionsHtml = '';
                if(order.status === 'pending') {
                    actionsHtml += `<button onclick="cancelOrder('${order.id}')" class="text-red-500 text-sm hover:underline mr-3">H·ªßy ƒë∆°n</button>`;
                }
                actionsHtml += `<button onclick="copyOrderContent('${order.id}')" class="text-blue-500 text-sm hover:underline">Sao ch√©p</button>`;

                // X·ª≠ l√Ω gi√° ti·ªÅn (C√≥ th·ªÉ ƒë√£ b·ªã admin ch·ªânh)
                let priceDisplay = formatCurrency(order.final_price || order.original_price);
                if(order.adjustment_fee !== 0) {
                    priceDisplay += ` <span class="text-xs text-gray-400 line-through">${formatCurrency(order.original_price)}</span>`;
                }

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <span class="px-2 py-1 rounded text-xs font-bold ${statusColor[order.status] || ''}">${order.status.toUpperCase()}</span>
                        <span class="font-bold text-red-600">${priceDisplay}</span>
                    </div>
                    ${detailHtml}
                    <div class="mt-2 pt-2 border-t flex justify-between items-center">
                        <span class="text-xs text-gray-400">${formatDate(order.created_at)}</span>
                        <div>${actionsHtml}</div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function cancelOrder(orderId) {
            if(!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n n√†y?")) return;
            // Check l·∫°i realtime xem admin ƒë√£ nh·∫≠n ch∆∞a (ƒë·ªÉ an to√†n)
            const { data } = await _supabase.from('orders').select('status').eq('id', orderId).single();
            if(data.status !== 'pending') {
                alert("Admin ƒë√£ ti·∫øp nh·∫≠n ƒë∆°n n√†y, kh√¥ng th·ªÉ h·ªßy. Vui l√≤ng chat ƒë·ªÉ h·ªó tr·ª£.");
                loadMyOrders();
                return;
            }
            
            await _supabase.from('orders').update({ status: 'cancelled' }).eq('id', orderId);
            loadMyOrders();
        }

        async function copyOrderContent(orderId) {
            const { data } = await _supabase.from('orders').select('*').eq('id', orderId).single();
            let textToCopy = "";
            
            if(data.type === 'text' && data.boards_data) {
                data.boards_data.forEach(b => {
                    textToCopy += `[B·∫¢NG ${b.id} - ${b.subject}]\n${b.content}\n----------------\n`;
                });
            } else {
                textToCopy = `ƒê∆°n in file: ${data.file_url}, ${data.page_count} trang.`;
            }
            
            navigator.clipboard.writeText(textToCopy);
            alert("ƒê√£ sao ch√©p n·ªôi dung!");
        }

        // --- CHAT SYSTEM ---
        function toggleChat() {
            const win = document.getElementById('chat-window');
            win.classList.toggle('hidden');
            if(!win.classList.contains('hidden')) loadMessages();
        }

        async function loadMessages() {
            const { data } = await _supabase
                .from('messages')
                .select('*')
                .or(`sender_id.eq.${currentUser.id},is_admin.eq.true`) // L·∫•y tin c·ªßa m√¨nh v√† tin c·ªßa admin
                .order('created_at', { ascending: true });
                
            const container = document.getElementById('chat-messages');
            container.innerHTML = '';
            data.forEach(msg => appendMessage(msg));
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if(!text) return;
            
            await _supabase.from('messages').insert({
                sender_id: currentUser.id,
                content: text,
                is_admin: false
            });
            input.value = '';
        }

        function appendMessage(msg) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            const isMe = msg.sender_id === currentUser.id;
            
            div.className = `flex ${isMe ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `
                <div class="max-w-[80%] p-2 rounded text-sm ${isMe ? 'bg-blue-100 text-blue-900' : 'bg-gray-200 text-gray-900'}">
                    ${msg.content}
                </div>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- REALTIME SUBSCRIPTION ---
        function subscribeRealtime() {
            _supabase
                .channel('public:orders')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'orders', filter: `user_id=eq.${currentUser.id}` }, payload => {
                    // Khi admin c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n -> Reload list
                    if(document.getElementById('view-my-orders').classList.contains('hidden') === false) {
                        loadMyOrders();
                    }
                    // Th√¥ng b√°o Toast ƒë∆°n gi·∫£n (C√≥ th·ªÉ n√¢ng c·∫•p)
                    console.log("ƒê∆°n h√†ng c·∫≠p nh·∫≠t:", payload.new);
                })
                .subscribe();

            _supabase
                .channel('public:messages')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                     // N·∫øu tin nh·∫Øn m·ªõi l√† c·ªßa admin ho·∫∑c c·ªßa m√¨nh th√¨ hi·ªán l√™n
                     if(payload.new.sender_id === currentUser.id || payload.new.is_admin) {
                         appendMessage(payload.new);
                     }
                })
                .subscribe();
        }

    </script>
</body>
</html>
