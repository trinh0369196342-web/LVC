<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fix Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Fix Admin Account</h1>
  
  <div>
    <h2>ÄÄƒng nháº­p Admin</h2>
    <input type="email" id="email" placeholder="Email" value="fuwun123@gmail.com">
    <input type="password" id="password" placeholder="Password" value="H@chin123">
    <button onclick="loginAndFix()">ÄÄƒng nháº­p & Fix</button>
  </div>

  <div id="result" style="margin-top: 20px;"></div>

  <script>
    const SUPABASE_URL = 'https://gvsbcjhohvrgaowflcwc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imd2c2JjamhvaHZyZ2Fvd2ZsY3djIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQwNzIyNTYsImV4cCI6MjA3OTY0ODI1Nn0.TMkVz82efXxfOazfhzKuWP-DYqVZY8M60WrtA4O77Xc';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function loginAndFix() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      const resultDiv = document.getElementById('result');

      try {
        resultDiv.innerHTML = 'Äang Ä‘Äƒng nháº­p...';
        
        // ÄÄƒng nháº­p
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });

        if (error) throw error;

        resultDiv.innerHTML = 'âœ… ÄÄƒng nháº­p thÃ nh cÃ´ng!<br>Äang táº¡o/fix user profile...';

        const userId = data.user.id;
        
        // Kiá»ƒm tra xem user profile Ä‘Ã£ tá»“n táº¡i chÆ°a
        const { data: existingUser, error: checkError } = await supabase
          .from('users')
          .select('*')
          .eq('id', userId)
          .single();

        if (checkError && checkError.code === 'PGRST116') {
          // User profile chÆ°a tá»“n táº¡i, táº¡o má»›i
          resultDiv.innerHTML += '<br>ğŸ‘¤ User profile chÆ°a tá»“n táº¡i, Ä‘ang táº¡o má»›i...';
          
          const { data: newUser, error: createError } = await supabase
            .from('users')
            .insert([
              {
                id: userId,
                name: 'Quáº£n trá»‹ viÃªn',
                email: email,
                phone: '0123456789',
                role: 'admin',
                status: 'active'
              }
            ])
            .select()
            .single();

          if (createError) throw createError;
          
          resultDiv.innerHTML += '<br>âœ… ÄÃ£ táº¡o user profile vá»›i quyá»n ADMIN!';
        } else if (existingUser) {
          // User profile Ä‘Ã£ tá»“n táº¡i, cáº­p nháº­t thÃ nh admin
          resultDiv.innerHTML += '<br>ğŸ‘¤ User profile Ä‘Ã£ tá»“n táº¡i, Ä‘ang cáº­p nháº­t thÃ nh admin...';
          
          const { error: updateError } = await supabase
            .from('users')
            .update({ 
              role: 'admin',
              name: 'Quáº£n trá»‹ viÃªn'
            })
            .eq('id', userId);

          if (updateError) throw updateError;
          
          resultDiv.innerHTML += '<br>âœ… ÄÃ£ cáº­p nháº­t user thÃ nh ADMIN!';
        }

        resultDiv.innerHTML += '<br><br>ğŸ‰ HoÃ n thÃ nh! Giá» hÃ£y:';
        resultDiv.innerHTML += '<br>1. Má»Ÿ <a href="admin.html" target="_blank">admin.html</a>';
        resultDiv.innerHTML += '<br>2. ÄÄƒng nháº­p láº¡i vá»›i email vÃ  password trÃªn';
        resultDiv.innerHTML += '<br>3. Kiá»ƒm tra xem Ä‘Ã£ vÃ o Ä‘Æ°á»£c trang admin chÆ°a';

      } catch (error) {
        resultDiv.innerHTML = 'âŒ Lá»—i: ' + error.message;
        console.error('Error:', error);
      }
    }
  </script>
</body>
</html>